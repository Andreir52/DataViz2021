---
title: "UK Accidents"
author: "Adrian Sandru, Andrei Rizescu"
date: "5/11/2021"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Dataset description

Our dataset consists of data regarding UK road accidents from 2005 to 2014 and the circumstances in which they happened. The dataset is split in 3 sub-sets. The main set include information 
about the accident severity, number of casualties and many more. The second one offers valuable details about the vehicles involved, as well as driver information. The last set includes information
about the victims of a specific accident. All sets are linked with a guide containing the text description of all variable code in the three files. 

## Introduction

The selected dataset provides enough information so we mainly focus on a subset including the severity of the accidents and how they are influenced by external factors, the age of the drivers, and the location of these events. 

Keeping this in mind we made multiple plots of the following types:

- bar plots
- radar charts
- timeseries plots
- pie plots
- a heatmap

## Data preparation

The data preparation consists in joining the main csvs with their lookup tables.

```{r eval=TRUE, error=FALSE, warning=FALSE, message=FALSE}
invisible({capture.output({
library(tidyverse)
library(readxl)
library(factoextra)
})})
```

```{r eval=FALSE, echo=T}
library(tidyverse)
library(readxl)
library(factoextra)

Accidents <- read_csv("./data/Accidents0514.csv")
Casualties <- read_csv("./data/Casualties0514.csv")
Vehicles <- read_csv("./data/Vehicles0514.csv")

df <- merge(Accidents, Casualties, by='Accident_Index')
df <- merge(df, Vehicles, by='Accident_Index')


Location_code <- read_excel("./data/Road-Accident-Safety-Data-Guide.xls", sheet="Police Force")
df <- left_join(df, Location_code, by=c("Police_Force"="code"))
df <- rename(df, Location=label)
rm(Location_code)

Casualty_severity <- read_excel("./data/Road-Accident-Safety-Data-Guide.xls", sheet="Accident Severity")
df <- left_join(df, Casualty_severity, by=c("Casualty_Severity"="code"))
df <- rename(df, Casualty_Outcome=label)
rm(Casualty_severity)
```

## Gender vs severity of the accidents

This barplot shows a comparison between genders based on the accident severity. It is generally believed that women are worse drivers than man and prone to cause more accidents. In this plot it can easily be observed that the no. of accidents caused by men almost doubles the one by woman in all categories.

```{r eval=TRUE, error=FALSE, warning=FALSE, message=FALSE}
source("data_preparation_r.R")

gender <- df %>% select(Casualty_Outcome, Gender) %>% 
  filter(Gender !="Data missing or out of range") %>% 
  group_by(Gender, Casualty_Outcome) %>% 
  summarise(t_count = n())
gender


ggplot(gender, aes(x=t_count, y=Gender, fill=Casualty_Outcome)) + 
  geom_bar(stat="identity") + 
  theme_minimal() +
  guides(fill = guide_legend(reverse=TRUE)) + 
  coord_flip() + 
  labs(y="Gender") +
  labs(x="Total count")
```

## Total accidents by hour

This plot shows when drivers are most prone to accidents. We can make an educated guess that the busiest hours are 9 and 17. The conclusion we can draw here is that main factors that lead to accidents are traffic jams and tiredness that occurs later in the day.

```{r eval=TRUE, error=FALSE, warning=FALSE, message=FALSE}
source("data_preparation_r.R")

df$Time_Slot <- as.numeric(substr(df$Time,0,2))

df %>%
  filter(Casualty_Outcome=="Serious")%>%
  group_by(Time_Slot) %>% 
  summarize(total_accidents=n_distinct(Accident_Index)) %>%
    ggplot(aes(x=Time_Slot, y=total_accidents)) +
    geom_bar(stat="identity", fill="steelblue")+
    geom_text(aes(label=total_accidents), vjust=1.6, color="black", size=3)+
    scale_x_continuous(breaks = round(seq(0, 24, by = 2),0)) +
    ggtitle("Total Serious Accidents by Hours from 2005 to 2014") +
    xlab("Hours") + ylab("Total Accidents")+
    theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank())
```

## Vehicle type vs Accidents severity

Here we can see that the biggest proportion of fatal accidents happen with vehicles over 7.5 tones.

```{r eval=TRUE, error=FALSE, warning=FALSE, message=FALSE}
source("data_preparation_r.R")

library(scales)

memory.limit(size=56000)

percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}

vehicle_code <- read_excel("./data/Road-Accident-Safety-Data-Guide.xls", sheet="Vehicle Type")
df <- left_join(df, vehicle_code, by=c("Vehicle_Type"="code"))
df <- rename(df, Vehicle_name=label)
rm(vehicle_code)

df %>% 
  group_by(Vehicle_name, Casualty_Outcome) %>% 
  summarize(total_accidents=n_distinct(Accident_Index)) %>%
  mutate(freq = percent(total_accidents / sum(total_accidents))) %>%
  ggplot(aes(x=Vehicle_name, y=freq,fill=Casualty_Outcome, order=Casualty_Outcome)) +
  geom_bar(stat="identity", position="dodge")+
  ggtitle("Accident Severity Proportion per vehicle") +
  xlab("Accident Severity") + ylab("Accident Proportion")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank())
```

## Accidents by junction type

Judging by this plot we can conclude that the mos dangerous type of junction is a T or staggerd junction, maybe due to their complex shape. Mini-roundabouts and roundabouts are safer for most drivers since they have to slow down before passing through it.

```{r eval=TRUE, error=FALSE, warning=FALSE, message=FALSE}
source("data_preparation_r.R")

junction_code <- read_excel("./data/Road-Accident-Safety-Data-Guide.xls", sheet="Junction Detail")
df <- left_join(df, junction_code, by=c("Junction_Detail"="code"))
df <- rename(df, junction_type_name=label)
rm(junction_code)

df %>% 
  filter(Casualty_Outcome=="Slight")%>%
  group_by(junction_type_name,Casualty_Outcome) %>% 
  summarize(total_accidents=n_distinct(Accident_Index)) %>%
  ggplot(aes(x=Casualty_Outcome, y=total_accidents,fill=junction_type_name)) +
  geom_bar(stat="identity", position="dodge")+
  ggtitle("Accident by Junction Type") +
  xlab(" ") + ylab("Total Accidents")+
  theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank(),axis.text.x = element_text(angle = 45, hjust = 1))
```


## Daily accidents

In this plot we can see the number of accidents on a daily basis and their frequency over 10 years. We can observe that most likely it can happen 4 accidents a day. 

```{r eval=TRUE, error=FALSE, warning=FALSE, message=FALSE}
source("data_preparation_r.R")

new_df<-df %>% 
        group_by(Date) %>% 
        filter(Casualty_Outcome=="Fatal")%>%
        summarize(total_accidents=n_distinct(Accident_Index))

hist(new_df$total_accidents,main="Daily Accidents",xlim=c(0.5,max(new_df$total_accidents)), breaks=max(new_df$total_accidents))
```


## Timeseries accidents over 10 years

We tried to visualize the data using time-series decomposition. It allows us to decompose our time series into three distinct components: trend, seasonality, and noise. We conclude that there is a descending trend in the number of accidents and also a seasonality, accidents seems to occur more frequently in winter.


```{r eval=TRUE, error=FALSE, warning=FALSE, message=FALSE}
source("data_preparation_r.R")
library(forecast)
library(lubridate)


df$Date_aux<- as.Date(df$Date, "%d/%m/%Y")
df$month_year <- format(df$Date_aux, "%Y-%m")


new_df<-df %>%  
  filter(Casualty_Outcome=="Fatal")%>%
  group_by(month_year) %>%
  arrange(month_year) %>%
  summarize(total_accidents=n_distinct(Accident_Index))


startDate<-min(df$Date)
endDate<-max(df$Date)
ts<- msts(new_df$total_accidents,seasonal.periods=12,start=decimal_date(as.Date(startDate, "%d/%m/%Y")))
plot(ts, main="Monthly Fatal Accidents", xlab="Year", ylab="Accidents")


ts.components <- decompose(ts)
plot(ts.components)
```


## Radar chart history of accidents over 10 years

Here we were curious about how the descending trend presented previously reflects reported to the type of intersection. We split the data into time periods of 2 years and we concluded that the most progress happened in case of "Not at junction". This could be a direct consequence of car safety regulations. 

```{r eval=TRUE, error=FALSE, warning=FALSE, message=FALSE}
source("data_preparation_r.R")


library(fmsb)

junction_code <- read_excel("./data/Road-Accident-Safety-Data-Guide.xls", sheet="Junction Detail")
df <- left_join(df, junction_code, by=c("Junction_Detail"="code"))
df <- rename(df, junction_type_name=label)
rm(junction_code)

df$Date_aux<- as.Date(df$Date, "%d/%m/%Y")
df_2006_2008<- df %>%  
  filter(Casualty_Outcome=="Slight")%>%
  filter(junction_type_name!="Data missing or out of range")%>%
  filter(Date_aux>=as.Date("01/01/2006", "%d/%m/%Y") & Date_aux<=as.Date("01/01/2008", "%d/%m/%Y"))%>%
  group_by(junction_type_name,Casualty_Outcome) %>% 
  summarize(total_accidents=n_distinct(Accident_Index))
df_2006_2008

df_2008_2010<- df %>%  
  filter(Casualty_Outcome=="Slight")%>%
  filter(Date_aux>=as.Date("01/01/2008", "%d/%m/%Y") & Date_aux<=as.Date("01/01/2010", "%d/%m/%Y"))%>%
  group_by(junction_type_name,Casualty_Outcome) %>% 
  summarize(total_accidents=n_distinct(Accident_Index))
df_2008_2010

df_2010_2012<- df %>%  
  filter(Casualty_Outcome=="Slight")%>%
  filter(Date_aux>=as.Date("01/01/2010", "%d/%m/%Y") & Date_aux<=as.Date("01/01/2012", "%d/%m/%Y"))%>%
  group_by(junction_type_name,Casualty_Outcome) %>% 
  summarize(total_accidents=n_distinct(Accident_Index))
df_2010_2012

df_2012_2014<- df %>%  
  filter(Casualty_Outcome=="Slight")%>%
  filter(junction_type_name!="Data missing or out of range")%>%
  filter(Date_aux>=as.Date("01/01/2012", "%d/%m/%Y") & Date_aux<=as.Date("01/01/2014", "%d/%m/%Y"))%>%
  group_by(junction_type_name,Casualty_Outcome) %>% 
  summarize(total_accidents=n_distinct(Accident_Index))
df_2012_2014

list_2006_2008 <- list(df_2006_2008$total_accidents) 
list_2008_2010 <- list(df_2008_2010$total_accidents)
list_2010_2012 <- list(df_2010_2012$total_accidents)
list_2012_2014 <- list(df_2012_2014$total_accidents)

junction_code = df_2012_2014$junction_type_name
junction_code

L1 = list(list_2006_2008, list_2008_2010, list_2010_2012, list_2012_2014)
L1 = as.data.frame(t(as.data.frame(L1)))
min_l1 = min(L1)
max_l1 = max(L1)
L1

# add 2 lines to the dataframe: the max and min of each variable to show on the plot!
data <- rbind(max_l1 , min_l1 , L1)
rownames(data) = c(1,2,3,4,5,6)
colnames(data) <- junction_code
data

# Color vector
colors_border=c( rgb(0.2,0.5,0.5,0.9), rgb(0.8,0.2,0.5,0.9) , rgb(0.7,0.5,0.1,0.9) )
colors_in=c( rgb(0.2,0.5,0.5,0.4), rgb(0.8,0.2,0.5,0.4) , rgb(0.7,0.5,0.1,0.4) )

# plot with default options:
radarchart( data  , axistype=1 , seg = 6,
            #custom polygon
            pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
            #custom the grid
            cglcol="grey", cglty=1, axislabcol="grey", cglwd=0.8, caxislabels=seq(0,max_l1,20000),
            #custom labels
            vlcex=0.8 
)

# Add a legend
legend_names <- c("2006-08", "2008-10", "2010-12", "2012-14")
legend(x=1.5, y=1, legend = legend_names, bty = "n", pch=20 , col=colors_in , text.col = "grey", cex=1.2, pt.cex=3)
```
