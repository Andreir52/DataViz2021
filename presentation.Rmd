---
title: "UK Accidents"
author: "Adrian Sandru, Andrei Rizescu"
date: "5/11/2021"
output: slidy_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Dataset description

Our dataset consists of data regarding UK road accidents from 2005 to 2014 and the circumstances in which they happened. The dataset is split in 3 sub-sets. The main set include information 
about the accident severity, number of casualties and many more. The second one offers valuable details about the vehicles involved, as well as driver information. The last set includes information
about the victims of a specific accident. All sets are linked with a guide containing the text description of all variable code in the three files. 

## Introduction

The selected dataset provides enough information so we mainly focus on a subset including the severity of the accidents and how they are influenced by external factors, the age of the drivers, and the location of these events. 

Keeping this in mind we made multiple plots of the following types:

- bar plots
- radar charts
- timeseries plots
- pie plots
- a heatmap

## Data preparation

The data preparation consists in joining the main csvs with their lookup tables.

```{r eval=TRUE, error=FALSE, warning=FALSE, message=FALSE}
invisible({capture.output({
library(tidyverse)
library(readxl)
library(factoextra)
})})
```

```{r eval=FALSE, echo=T}
library(tidyverse)
library(readxl)
library(factoextra)

Accidents <- read_csv("./data/Accidents0514.csv")
Casualties <- read_csv("./data/Casualties0514.csv")
Vehicles <- read_csv("./data/Vehicles0514.csv")

df <- merge(Accidents, Casualties, by='Accident_Index')
df <- merge(df, Vehicles, by='Accident_Index')


Location_code <- read_excel("./data/Road-Accident-Safety-Data-Guide.xls", sheet="Police Force")
df <- left_join(df, Location_code, by=c("Police_Force"="code"))
df <- rename(df, Location=label)
rm(Location_code)

Casualty_severity <- read_excel("./data/Road-Accident-Safety-Data-Guide.xls", sheet="Accident Severity")
df <- left_join(df, Casualty_severity, by=c("Casualty_Severity"="code"))
df <- rename(df, Casualty_Outcome=label)
rm(Casualty_severity)
```

## Gender vs severity of the accidents

This barplot shows a comparison between genders based on the accident severity
```{r eval=TRUE}
source("data_preparation_r.R")

gender <- df %>% select(Casualty_Outcome, Gender) %>% 
  filter(Gender !="Data missing or out of range") %>% 
  group_by(Gender, Casualty_Outcome) %>% 
  summarise(t_count = n())
gender


ggplot(gender, aes(x=t_count, y=Gender, fill=Casualty_Outcome)) + 
  geom_bar(stat="identity") + 
  theme_minimal() +
  guides(fill = guide_legend(reverse=TRUE)) + 
  coord_flip() + 
  labs(y="Gender") +
  labs(x="Total count")
```

## Total accidents by hour

This plot shows when drivers are most prone to accidents
```{r eval=TRUE}
source("data_preparation_r.R")

df$Time_Slot <- as.numeric(substr(df$Time,0,2))

df %>%
  filter(Casualty_Outcome=="Serious")%>%
  group_by(Time_Slot) %>% 
  summarize(total_accidents=n_distinct(Accident_Index)) %>%
    ggplot(aes(x=Time_Slot, y=total_accidents)) +
    geom_bar(stat="identity", fill="steelblue")+
    geom_text(aes(label=total_accidents), vjust=1.6, color="black", size=3)+
    scale_x_continuous(breaks = round(seq(0, 24, by = 2),0)) +
    ggtitle("Total Serious Accidents by Hours from 2005 to 2014") +
    xlab("Hours") + ylab("Total Accidents")+
    theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank())
```

## Vehicle type vs Accidents severity

This plot shows when drivers are most prone to accidents
```{r eval=TRUE}
source("data_preparation_r.R")

library(scales)

memory.limit(size=56000)

percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}

vehicle_code <- read_excel("./data/Road-Accident-Safety-Data-Guide.xls", sheet="Vehicle Type")
df <- left_join(df, vehicle_code, by=c("Vehicle_Type"="code"))
df <- rename(df, Vehicle_name=label)
rm(vehicle_code)

df %>% 
  group_by(Vehicle_name, Casualty_Outcome) %>% 
  summarize(total_accidents=n_distinct(Accident_Index)) %>%
  mutate(freq = percent(total_accidents / sum(total_accidents))) %>%
  ggplot(aes(x=Vehicle_name, y=freq,fill=Casualty_Outcome)) +
  geom_bar(stat="identity", position="dodge")+
  geom_text(aes(label=freq), vjust=1.6, color="black", size=3)+
  ggtitle("Accident Severity Proportion per vehicle") +
  xlab("Accident Severity") + ylab("Accident Proportion")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  theme(plot.title = element_text(hjust = 0.5), panel.background = element_blank())
```